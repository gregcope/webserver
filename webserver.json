{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "Sets up a WebServer instance on AML2 in US-West 1, opens ingress security groups as well as configuring the webserver",

  "Resources" : {
     "WebPageTestServerInstance" : {
       "Type" : "AWS::EC2::Instance",
       "Properties"       : {
        "ImageId"        : "ami-0e65ed16c9bf1abc7",
		"InstanceType"   : "t3a.small",
		"KeyName"        : { "Ref" : "KeyName" },
	 	"SecurityGroups" : [{ "Ref" : "HTTPHTTPSInboundFromAnywhere" }],
	 	"UserData"       : { "Fn::Base64" : { "Fn::Join" : ["", [
	   "#!/bin/bash -v\n",
	   "/usr/bin/sudo yum update -y\n",
	   "/usr/bin/sudo yum install -y httpd\n",
	   "/usr/bin/sudo yum -y install yum-cron\n",
	   "/usr/bin/sudo systemctl start httpd\n",
	   "/usr/bin/sudo systemctl enable httpd\n",
	   "/usr/bin/sudo systemctl enable yum-cron.service\n",
	   "/usr/bin/sudo systemctl start yum-cron.service\n",
	   "echo 'Hello AWS!' >> /var/www/html\n"
	   ]]}
	 },
	 "Tags" : [
	   { "Key" : "Name", "Value" : "webServerInstance" },
	   { "Key" : "env", "Value" : "dev" },
	   { "Key" : "Xcode", "Value" : "11" },
	   { "Key" : "role", "Value" : "Web Server instance" }
	 ]
       }
     },
     
     "HTTPHTTPSInboundFromAnywhere" : {
	"Type" : "AWS::EC2::SecurityGroup",
	"Properties" : {
	  "GroupDescription" : "Enable HTTP, HTTPS",
	  "SecurityGroupIngress" : 
	    [  
	      { "IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "CidrIp" : "0.0.0.0/0" },
	      { "IpProtocol" : "tcp", "FromPort" : "443", "ToPort" : "443", "CidrIp" : "0.0.0.0/0" }
	    ]
	}
     }
  },
  "Outputs" : {
    "PublicIP" : {
      "Description" : "The IP of the web server",
      "Value" : { "Fn::GetAtt" : [ "WebServerInstance", "PublicIp" ] }
    }
  }		    
}

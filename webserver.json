{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "Sets up a Web Page Test Server instance on Ubuntu 12.04, and then downloads and does a puppet run to install/config instance",
  "Parameters": {
    "WebPageTestKey" : { "Description" : "The Web Page Test Key for client/server/API comms", "Type" : "String", "Default" : "61c74f0abc0cc3c018963bf72191aff6" },
    "KeyName" : { "Description" : "The EC2 Key Pair to allow SSH access to the instances", "Type" : "String", "Default" : "greg2" }
  },

  "Mappings" : { 
    "AWSRegionArch2AMI" : {
      "us-east-1"        : {"HVM64" : "ami-0ff8a91507f77f867", "HVMG2" : "ami-0a584ac55a7631c0c"},
      "us-west-2"        : {"HVM64" : "ami-a0cfeed8", "HVMG2" : "ami-0e09505bc235aa82d"},
      "us-west-1"        : {"HVM64" : "ami-0bdb828fd58c52235", "HVMG2" : "ami-066ee5fd4a9ef77f1"},
      "eu-west-1"        : {"HVM64" : "ami-047bb4163c506cd98", "HVMG2" : "ami-0a7c483d527806435"},
      "eu-west-2"        : {"HVM64" : "ami-f976839e", "HVMG2" : "NOT_SUPPORTED"},
      "eu-west-3"        : {"HVM64" : "ami-0ebc281c20e89ba4b", "HVMG2" : "NOT_SUPPORTED"},
      "eu-central-1"     : {"HVM64" : "ami-0233214e13e500f77", "HVMG2" : "ami-06223d46a6d0661c7"},
      "ap-northeast-1"   : {"HVM64" : "ami-06cd52961ce9f0d85", "HVMG2" : "ami-053cdd503598e4a9d"},
      "ap-northeast-2"   : {"HVM64" : "ami-0a10b2721688ce9d2", "HVMG2" : "NOT_SUPPORTED"},
      "ap-northeast-3"   : {"HVM64" : "ami-0d98120a9fb693f07", "HVMG2" : "NOT_SUPPORTED"},
      "ap-southeast-1"   : {"HVM64" : "ami-08569b978cc4dfa10", "HVMG2" : "ami-0be9df32ae9f92309"},
      "ap-southeast-2"   : {"HVM64" : "ami-09b42976632b27e9b", "HVMG2" : "ami-0a9ce9fecc3d1daf8"},
      "ap-south-1"       : {"HVM64" : "ami-0912f71e06545ad88", "HVMG2" : "ami-097b15e89dbdcfcf4"},
      "us-east-2"        : {"HVM64" : "ami-0b59bfac6be064b78", "HVMG2" : "NOT_SUPPORTED"},
      "ca-central-1"     : {"HVM64" : "ami-0b18956f", "HVMG2" : "NOT_SUPPORTED"},
      "sa-east-1"        : {"HVM64" : "ami-07b14488da8ea02a0", "HVMG2" : "NOT_SUPPORTED"},
      "cn-north-1"       : {"HVM64" : "ami-0a4eaf6c4454eda75", "HVMG2" : "NOT_SUPPORTED"},
      "cn-northwest-1"   : {"HVM64" : "ami-6b6a7d09", "HVMG2" : "NOT_SUPPORTED"}
    }
  },

  "Resources" : {
     "WebPageTestServerInstance" : {
       "Type" : "AWS::EC2::Instance",
       "Properties"       : {
         "ImageId"        : { "Fn::FindInMap" : [ "AWSRegionArch2AMI", { "Ref" : "AWS::Region" }, "HVM64" ]},
	 "InstanceType"   : "t2.nano",
	 "KeyName"        : { "Ref" : "KeyName" },
	 "SecurityGroups" : [{ "Ref" : "HTTPHTTPSInboundFromAnywhere" }],
	 "UserData"       : { "Fn::Base64" : { "Fn::Join" : ["", [
	   "#!/bin/bash -v\n",
	   "/usr/bin/sudo yum update -y\n",
	   "/usr/bin/sudo yum install -y httpd\n",
	   "/usr/bin/sudo yum -y install yum-cron\n",
	   "/usr/bin/sudo systemctl start httpd\n",
	   "/usr/bin/sudo systemctl enable httpd\n",
	   "/usr/bin/sudo systemctl enable yum-cron.service\n",
	   "/usr/bin/sudo systemctl start yum-cron.service\n",
	   "echo 'Hello AWS!' >> /var/www/html\n"
	   ]]}
	 },
	 "Tags" : [
	   { "Key" : "Name", "Value" : "webServerInstance" },
	   { "Key" : "env", "Value" : "dev" },
	   { "Key" : "Xcode", "Value" : "11" },
	   { "Key" : "role", "Value" : "Web Server instance" }
	 ]
       }
     },
     
     "HTTPHTTPSInboundFromAnywhere" : {
	"Type" : "AWS::EC2::SecurityGroup",
	"Properties" : {
	  "GroupDescription" : "Enable HTTP, HTTPS",
	  "SecurityGroupIngress" : 
	    [  
	      { "IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "CidrIp" : "0.0.0.0/0" },
	      { "IpProtocol" : "tcp", "FromPort" : "443", "ToPort" : "443", "CidrIp" : "0.0.0.0/0" }
	    ]
	}
     }
  },
  "Outputs" : {
    "PublicIP" : {
      "Description" : "The IP of the web server",
      "Value" : { "Fn::GetAtt" : [ "WebServerInstance", "PublicIp" ] }
    }
  }		    
}
